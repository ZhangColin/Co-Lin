# DDD战略设计 - 控制复杂度的方法论

## 说明
这是通过阅读《Implementing Domain-Driven Design》(Vaughn Vernon)、《解构领域驱动设计》(张逸)等DDD材料后，提炼出的战略设计方法论。

**核心贡献来源**：
- **四重边界框架**：来自张逸《解构领域驱动设计》，这是控制复杂度的关键洞察
- **战术模式与实践**：主要来自Vaughn Vernon的IDDD
- **原始理论基础**：Eric Evans的DDD开山之作

战略设计是DDD的核心价值所在，是一套处理复杂问题的思维方式，适用于软件开发之外的广泛领域。

---

## 一、核心理念

### DDD解决什么问题
软件开发最大的挑战：**复杂性**

复杂度来源于三个方面：
1. **业务本身的复杂度**：业务规则复杂、领域知识深
2. **技术解决方案带来的复杂度**：框架、架构、技术选型的复杂性
3. **遗留系统带来的复杂度**：历史包袱、技术债务、大泥球

### DDD的精髓：四重边界

**边界是核心**。从宏观到微观，DDD强调对边界的划分与控制，形成四重边界：

1. **第一重：子领域边界**（问题空间）
   - 划定核心、支撑、通用子域
   - 理清优先级，聚焦核心域
   
2. **第二重：限界上下文边界**（解决方案空间）
   - 降低系统规模（业务、架构、团队）
   - 外部世界：契约、通信、系统级架构
   - 内部世界：分层、协作、类级设计
   
3. **第三重：分层架构边界**（六边形架构）
   - 隔离业务复杂度与技术复杂度
   - 领域层 = 稳定内核（本质的不变性）
   - 外部资源 = 偶然的不变性
   
4. **第四重：聚合边界**（最小设计单元）
   - 保护完整性与一致性
   - 通过ID关联，避免引用依赖
   - 因为下层边界职责清晰，所以上层划分错了也容易重新调整

**四重边界的调整逻辑**：
- 因为下层边界职责清晰，所以上层划分错了也容易重新调整
- 调整的是上层的重新划分，下层最多是归属（跟谁走）的问题
- 不需要修改下层本身

### DDD的价值主张
1. **让业务专家和开发者说同一种语言**（统一语言）
2. **让软件模型真实反映业务理解**（代码即设计）
3. **战略设计保护核心域**（投资在最重要的地方）
4. **战术模式保证实现质量**（技术卓越）

---

## 二、战略设计 - 识别边界和关系

### 问题空间 vs 解决空间

**问题空间**（战略分析）：
- Domain（领域）：业务活动范围
- Subdomain（子域）：
  - Core Domain：核心竞争力，必须自己做好
  - Supporting Subdomain：支撑核心的，需要定制
  - Generic Subdomain：通用功能，可购买或简单实现

**解决空间**（软件实现）：
- Bounded Context：有明确边界的领域模型
- 理想状态：一个Subdomain对应一个Bounded Context

### Bounded Context - 语言边界

**本质**：
- 不是技术边界，是**语言边界**
- 边界内的每个术语都有**确切无疑**的含义
- 同一个词在不同Context中可以有完全不同的含义

**关键原则**：
- Context is King（上下文为王）
- 不要追求企业级统一模型（那是陷阱）
- 拥抱差异，用明确边界隔离差异

**包含范围**：
- 领域模型（核心）
- UI、Application Services
- 为模型设计的数据库Schema
- 集成接口（REST、消息等）

**大小原则**：
- 像莫扎特作曲：不多不少，刚好表达完整的统一语言
- 由语言驱动，不由架构或资源分配驱动
- 一个团队负责一个Bounded Context

### Context Mapping - 集成关系

**九种组织和集成模式**：

**合作型**：
- Partnership：共同进退
- Shared Kernel：共享模型部分（需谨慎使用）

**供需型**：
- Customer-Supplier：下游需求影响上游
- Conformist：下游被动接受上游

**隔离型**：
- Anticorruption Layer（ACL）：防腐层保护本地模型
- Open Host Service（OHS）：上游提供标准服务
- Published Language（PL）：定义交换语言
- Separate Ways：完全独立

**现实型**：
- Big Ball of Mud：承认混乱，划清边界，不要被污染

**上游/下游关系**：
- Upstream（上游）：影响他人
- Downstream（下游）：被他人影响
- 像河流，上游的变化会影响下游

---

## 三、重构至深层洞察（Eric Evans原著精华）

### Breakthrough（突破）

**真实案例：Share Pie的发现**

问题：需求变更神秘、舍入错误、复杂度失控。

突破：发现"Shares"是隐藏的核心概念——Facility的份额、Loan的份额、Payment的份额。

艰难决策：项目严重延期，仍决定花3周全面重构。

回报：需求变更停止、问题解决、开发加速、连锁突破。

**关键原则**：
- 不追求突破，专注基础（知识消化+统一语言+显式化概念）
- 不因害怕放弃小改进
- 突破来自积累

### 让隐含概念显式化

**五种发现方法**：

1. **倾听语言**：专家反复用的词、纠正的词
2. **审视别扭处**：最复杂难解释的地方
3. **读书学习**：利用领域成熟理论
4. **思考矛盾**：专家矛盾说法可能指向深层概念
5. **反复尝试**：接受试错

**SPECIFICATION模式**：

独立的规格说明对象，三大用途：
- Validation（验证）
- Selection（查询选择）
- Building-to-Order（按需构建）

可用逻辑运算符组合（and/or/not），形成声明式风格。

### Supple Design（柔性设计）

**核心理念**：深度模型+柔性设计=开发加速。Simple is not easy。

**六大模式**：

1. **INTENTION REVEALING INTERFACES**：名字表达意图（what），不表达手段（how）

2. **SIDE-EFFECT-FREE FUNCTIONS**：查询和命令分离，用VALUE OBJECT承载计算，返回新对象而非修改现有对象

3. **ASSERTIONS**：后置条件、前置条件、不变量——让副作用显式可预测

4. **CONCEPTUAL CONTOURS**：沿着领域自然边界切分，每个对象是完整概念（WHOLE VALUE）

5. **STANDALONE CLASSES**：消除非本质依赖，将复杂计算提炼到可独立理解的VALUE OBJECT

6. **CLOSURE OF OPERATIONS**：返回类型与参数类型相同（如实数加法），易于组合，不引入额外概念

**声明式设计**：

理想是用规范直接控制软件，现实中狭窄范围的框架（如ORM）效果较好。SPECIFICATION的逻辑组合接近声明式编程。

---

## 四、关键反模式警示

### 不要做的事

1. **不要用技术架构划分Bounded Context**
   - 错误：一个Context用于UI，一个用于数据访问
   - 正确：按业务语言边界划分

2. **不要为了资源分配划分Context**
   - 错误：因为有两个团队就分两个Context
   - 正确：用Module组织，不要拆Context

3. **不要追求企业级统一模型**
   - 错误：所有人用同一个Customer定义
   - 正确：在不同Context中Customer有不同含义

4. **不要过度拆分或过度合并**
   - 拆得太细：失去统一语言的表达力
   - 合得太粗：变成大泥球
   - 标准：语言边界

---

## 五、战略设计检查清单

### 战略检查
- [ ] 识别出核心域了吗？
- [ ] 核心域投入了最好的资源吗？
- [ ] Bounded Context边界清晰吗？
- [ ] 边界由语言驱动，不是技术或组织驱动？
- [ ] 画了Context Map吗？
- [ ] 集成关系明确吗（ACL/OHS/PL）？
- [ ] 上下游关系清楚吗？

### 团队协作检查
- [ ] 领域专家持续参与吗？
- [ ] 团队说统一语言吗？
- [ ] 有定期的建模讨论吗？

---

## 六、实用主义原则

**战略与战术的区别**：
- **战略设计**：控制复杂度的方法论，离开软件开发也能用
- **战术设计**：代码层面的实现细节、约束和模式

**DDD适用性的实用主义答案**：
- 战略思维从一开始就用（拆分、边界、职责）
- 战术模式根据团队能力选择（CRUD或复杂模式）
- 不要纠结量化指标判断何时用DDD
- 战略做好了，代码层面用什么都可以

**方法已内化，提理由不提名称**：
- 即使用DDD方式处理问题，也应该说理由而非名称
- 不要什么都套DDD，手里有锤子不能见什么都是钉子

---

**最后的话**：

战略设计是DDD的核心价值。它教会我们：
1. 用边界控制复杂度
2. 用语言建立共识
3. 用重构获得突破

这套思维方式，可以应用到工作、生活的各个方面。

